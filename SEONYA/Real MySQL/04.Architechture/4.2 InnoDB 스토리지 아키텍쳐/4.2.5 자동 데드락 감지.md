---
tags:
  - MySQL
  - DeadLock
---
###### 데드락 : 교착상태를 뜻한다. 두개 이상의 작업이 서로 상대방의 작업이 끝나기만을 기다리는 상태다. 


### 잠금 대기 목록 그래프(Wait-for List)과 데드락 감지 스레드
InnoDB 스토리지 엔진은 내부적으로 잠금이 교착 상태에 빠지지 않았는지 체크하기 위해 잠금 대기 목록 그래프(Wait-for List) 형태로 관리한다. InnoDB 스토리지 엔진은 데드락 감지 스레드를 가지고 있어 **데드락 감지 스레드**가 주기적으로 잠금 대기 그래프를 검사해 **교착 상태에 빠진 트랜잭션들을 찾아서 그 중 하나를 강제 종료**한다.

**강제 종료를 판단하는 기준은 언두 로그의 양**이며, 언두 로그의 양이다.
언두 로그 레코드를 더 적게 가진 트랜잭션이 일반적으로 롤백의 대상이 된다.
트랜잭션이 언두 레코드를 적게 가졌다는 이야기는 롤백을 해도 언두 처리를 해야 할 내용이 적다는 것이고 트랜잭션 강제 롤백으로 인한 MySQL 서버의 부하도 덜 유발하기 때문이다.

### 데드락 감지 범위와 innodb_table_locks 시스템 변수
InnoDB 스토리지 엔진은 상위 레이어인 MySQL 엔진에서 관리되는 테이블 잠금(LOCK TABLES)은 볼 수 가 없어서 데드락 감지가 불확실 할수도 있다.
innodb_table_locks 시스템 변수를 활성화 하면 InnoDB 스토리지 엔진 내부의 레코드 잠금뿐만 아니라 테이블 레벨의 잠금까지 감지할 수 있게 된다. 
특별한 이유가 없다면 innodb_table_locks 시스템 변수를 활성화 하자.

### 데드락 감지 스레드의 부하와 innodb_deadlock_detect 시스템 변수
일반적인 서비스에서는 데드락 감지 스레드가 트랜잭션의 잠금 목록을 검사해서 데드락을 찾아내는 작업은 크게 부담되지 않는다. 그러나 동시 처리 스레드가 매우 많아지거나 트랜잭션이 가진 잠금의 개수가 많아지면 데드락 감지 스레드가 느려진다. 

데드락 감지 스레드가 느려지면 서비스 쿼리를 처리 중인 스레드는 더는 작업을 진행하지 못하고 대기하면서 서비스에 악영향을 미치게된다. 
동시처리 스레드가 매우 많은 경우 데드락 감지 스레드는 더 많은 CPU 자원을 소모할 수도 있다.

MySQL 서버는 innodb_deadlock_detect 시스템 변수를 제공한다.
innodb_deadlock_detect를 OFF로 설정하면 데드락 감지 스레드는 더는 작동하지 않게 된다. 데드락 감지 스레드가 작동하지 않으면 InnoDB 스토리지 엔진 내부에서 2개 이상의 트랙잭션이 상대방이 가진 잠금을 요구하는 상황이 발생해도 누군가가 중재하지 않지 때문에 무한정 대기를 하게 된다.

하지만 innodb_lock_wait_timeout 시스템 변수를 활성화하면 이런 데드락 상황에서 일정 시간이 지나면 자동으로 요청이 실패하고 에러매시지를 반환하게 된다. 
innodb_lock_wait_timeout는 초단위로 설정 할 수 있다. 설정한 시간동안 잠금을 획득하지 못하면 쿼리는 실패하고 에러를 반환한다. 데드락 감지 스레드가 부담되어 
 innodb_deadlock_detect를 OFF로 설정해서 비활성화하는 경우라면 innodb_lock_wait_timeout을 기본값인 50초보다 훨씬 낮은 시간으로 변경해서 사용할 것을 권장한다.
 
```ad-note
title:실제 서비스에서의 innodb_deadlock_detect
구글에서는 PK 키 기반의 조회 및 변경이 아주 높은 빈도로 실행되는 서비스가 많았는데, 이런 서비스는 매우 많은 트랜잭션을 동시에 실행하기 때문에 데드락 감지 스레드가 상당히 성능을 저하 시킨다는 것을 알아냈다.
만약 PK또는 세컨더리 인덱스를 기반으로 매우 높은 동시성 처리를 요구하는 서비스가 있다면, innodb_deadlock_detect를 비활성화해서 성능 비교를 해보는것도 나쁘지 않다.
```


