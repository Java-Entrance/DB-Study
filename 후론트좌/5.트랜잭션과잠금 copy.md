# 트랜잭션

Mysql의 동시성에 영향을 미치는 잠금(락)과 트랜잭션, 트랜잭션의 격리 수준에 대해서 살펴보자.

### 트랜잭션?

- 트랜잭션은 작업의 완전성을 보장해 주는 것
- 즉 논리적인 작업 셋을 모두 완벽하게 처리하거나 처리하지 못할 경우에는 원 상태로 복구해서 작업의 일부만 적용되는 현상(`Partial update`)이 발생하지 않게 만들어주는 기능이다.

- 잠금(Lock)과 트랜잭션은 서로 비슷한 개념 같지만 사실 잠금은 동시성을 제어하기 위한 기능이고 트랜잭션은 데이터의 정합성을 보장하기 위한 기능이다.
- 하나의 회원 정보 레코드를 여러 커넥션에서 동시에 변경하려고 하는데 잠금이 없다면 하나의 데이터를 여러 커넥션에서 동시에 변경할 수 있게 된다.
- 결과적으로 해당 레코드의 값은 예측할 수 없는 상태가 된다.
- 잠금은 여러 커넥션에서 동시에 동일한 자원을 요청할 경우 순서대로 한 시점에는 하나의 커넥션만 변경할 수 있게 해주는 역할을 한다.
- 격리 수준이라는 것은 하나의 트랜잭션 내에서 또는 여러 트랜잭션 간의 작업 내용을 어떻게 공유하고 차단할 것인지를 결정하는 레벨을 의미한다.

### Partial update?

- 테이블의 특정 로우에 있는 하나 또는 그 이상의 컬럼 값만을 변경하는것을 말한다.
- 전체 로우를 업데이트하는 것이 아니라 선택된 컬럼들에 대해서만 변경을 적용하는 것이다.
- 이는 데이터의 일부만 변경할 때 효율적이며, 네트워크 대역폭과 서버 자원을 절약하는데 도움이 된다.

```sql
UPDATE users
SET meail = 'test@naver.com', phone = '1234567890'
WHERE user_id = 1;
```

- 이러한 구문은 'user_id'가 1인 사용자의 메일과, 폰 걸럼만을 업데이트 한다.

- 효율성
  - 필요한 데이터만 업데이트하기 때문에, 잔체 로우를 업데이트한다
- 네트워크 대역폭 절약
  - 클라이언트와 서버간에 전송되는 데이터 양이 줄어들어 네트워크 부하가 감소한다.
- 성능 개선
  - 데이터베이스 서버의 부하가 줄어들어 전체적인 시스템 성능이 향상된다
- 동시성 제어
  - 전체 로우가 아닌 일부 컬럼만 업데이트 되므로, 다른 프로세스나 트랜잭션에 의해 동시에 접근되는 경우에도 충돌의 가능성이 줄어든다.

## 트랜잭션

---

- MYISAM이나 MEMORY 스토리지 엔진이 더 빠르다고 생각하고 InnoDB 스토리지 엔진은 사용하기 복잡하고 번거롭다 생각하지만 InnoDB가 트랜잭션을 지원하는 처리 방식 차이에 대해서 살펴보고자 하는거같다.

### Mysql에서의 트랜잭션

- 트랜잭션은 하나의 논리적인 작업 셋에 하나의 쿼리가 있든 두 개 이상의 쿼리가 있든 관계없이 논리적인 작업 셋 자체가 100% 적용되거나 아무것도 적용되지 않아야함을 보장해 주는 것이다.

- MyISAM은 도중에 실패해도 전체 롤백이 안되고 InnoDB는 쿼리 중 일부라도 오류가 발생하면 전체를 원 상태로 만든다.
- MyISAM테이블에서 발생하는 이러한 현상을 부분 업데이트(Partial Update)라고 표현하며, 이러한 부분 업데이트 현상은 테이블 데이터의 정합성을 맞추는데 상당히 어려운 문제를 만들어 낸다.

### 글로벌 락

### 테이블 락

### 네임드 락

### 메타데이터 락

## Mysql 격리 수준(isolation level)

- 여러 트랜잭션이 동시에 처리될 때 특정 트랜잭션이 다른 트랜잭션에서 변경하거나 조회하는 데이터를 볼 수 있게 허용할지 말지를 결정하는 것

### 격리 수준은 크게 4가지로 나뉜다.

- READ UNCOMMITTED
- READ COMMITTED
- REPEATABLE READ
- SERIALIZABLE

- DIRTY READ라고도 하는 READ UNCOMMITTED는 일반적인 데이터베이스에서는 거의 사용하지 않고,
- SERIALIZABLE또한 동시성이 중요한 데이터베이스에서는 거의 사용되지 않는다.

4개의 격리 수준에서 순서대로 뒤로 갈수록 각 트랜잭션 간의 데이터 격리(고립) 정도가 높아지며, 동시 처리 성능도 떨어지는 것이 일반적이라고 볼 수 있다.

- 격리 수준이 높아질수록 MySQL 서버의 처리 성능이 많이 떨어질 것으로 생각하는 사용자가 많은데, 사실 SERIALIZABLE 격리 수준이 아니라면 크게 성능의 개선이나 저하는 발생하지 않는다.

![[Pasted image 20231226020800.png]]

### READ UNCOMMITTED

- 트랜잭션에서의 변경 내용이 COMMIT, ROLLBACK 여부에 상관없이 다른 트랜잭션에서 보인다.

### READ COMMITTED

- 오라클 DBMS에서 기본으로 사용되는 격리 수준 온라인 서비스에서 가장 많이 선택되는 격리 수준.
- 더티 리드 같은 현상은 발생하지 않는다.
- COMMIT이 완료된 데이터만 다른 트랜잭션에서 조회할 수 있기 떄문이다.

### REPEATABLE READ

- InnoDB 스토리지 엔진에서 기본으로 사용되는 격리 수준
- 바이너리 로그를 가진 Mysql 서버에서는 최소 이 격리 수준 이상을 사용해야 한다.
- InnoDB 스토리지 엔진은 트랜잭션이 ROLLBACK 될 가능성에 대비해 변경되기 전 레코드를 언두(Undo)공간에 백업해두고 실제 레코드 값을 변경한다. 이러한 방식을 MVCC라고 한다
- 이 격리 수준은 언두 영역에 백엽된 이전 데이터를 이용해 동일 트랜잭션 내에서는 동일한 결과를 보여줄 수 있게 보장한다.
